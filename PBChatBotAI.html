<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Planet Beauty AI Chatbot - Find personalized beauty products with our interactive assistant.">
    <title>Planet Beauty AI Chatbot</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script> <!-- Added Papaparse for CSV parsing -->
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXXXXXX'); // Replace with your GA ID
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            overflow-x: hidden;
        }
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        #preloader .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e91e63;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .chat-container {
            max-width: 900px;
            margin: 0 auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 12px;
            background: white;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 140px);
            max-height: 800px;
        }
        .chat-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            scroll-behavior: smooth;
            will-change: scroll-position;
        }
        .user-message {
            background: #e91e63;
            color: white;
            padding: .75rem 1rem;
            border-radius: 15px 15px 0 15px;
            max-width: 80%;
            margin-left: auto;
            margin-bottom: 1rem;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .bot-message {
            background: #f0f0f0;
            color: #333;
            padding: .75rem 1rem;
            border-radius: 15px 15px 15px 0;
            max-width: 80%;
            margin-right: auto;
            margin-bottom: 1rem;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .product-card {
            display: block;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            margin: 1rem 0;
            text-decoration: none;
            color: inherit;
            background: white;
            max-width: 80%;
            margin-right: auto;
        }
        .product-card:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }
        .lazyload, .lazyloading {
            opacity: 0;
            transition: opacity 0.3s;
        }
        .lazyloaded {
            opacity: 1;
        }
        .image-loading {
            position: relative;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f5f5f5;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(233, 30, 99, 0.2);
            border-top-color: #e91e63;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .image-placeholder {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8f9fa, #e91e63);
            color: white;
            font-size: 0.9em;
            text-align: center;
            transition: opacity 0.3s ease;
        }
        .image-placeholder:hover {
            opacity: 0.9;
        }
        .product-info {
            padding: 1rem;
        }
        .product-name {
            font-weight: 600;
            margin-bottom: .25rem;
        }
        .product-description {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: .5rem;
        }
        .product-price {
            font-weight: 500;
            color: #e91e63;
        }
        .examples-container {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
            margin-bottom: 1rem;
            max-width: 80%;
        }
        .example-chip {
            padding: .5rem 1rem;
            background: #f0f0f0;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.3s, box-shadow 0.2s;
            font-size: 0.9rem;
        }
        .example-chip:hover {
            background: #e91e63;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .example-chip:focus {
            outline: 2px solid #e91e63;
            outline-offset: 2px;
        }
        .input-area {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #eee;
            background: #fff;
        }
        .input-row {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        input[type=text] {
            flex: 1;
            padding: .75rem 1rem;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            transition: border-color 0.3s;
        }
        input[type=text]:focus {
            border-color: #e91e63;
        }
        input[type=text]:disabled {
            background-color: #f5f5f5;
        }
        .send-btn {
            background: #e91e63;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            flex-shrink: 0;
        }
        .send-btn:hover {
            background: #d81b60;
            transform: scale(1.05);
        }
        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: .75rem 1rem;
            border-radius: 15px;
            margin-bottom: 1rem;
            max-width: 80%;
            margin-right: auto;
            border: 1px solid #f4c7c7;
        }
        .retry-btn {
            background: none;
            border: none;
            color: #e91e63;
            text-decoration: underline;
            cursor: pointer;
        }
        footer {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 0.5rem 1rem;
            color: #6c757d;
            font-size: 0.875rem;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        footer a {
            color: #e91e63;
            text-decoration: none;
            margin-left: 0.25rem;
        }
        footer a:hover {
            text-decoration: underline;
        }
        #typing-indicator .typing-dots {
            display: inline-block;
            width: 1.5em;
            text-align: left;
            vertical-align: bottom;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @media (max-width: 640px) {
            body {
                padding: 0;
            }
            .chat-container {
                border-radius: 0;
                max-width: 100%;
                height: 100vh;
                max-height: none;
                margin: 0;
            }
            .chat-area {
                padding: 1rem;
            }
            .user-message, .bot-message, .product-card, .examples-container, .error-message {
                max-width: 90%;
            }
            .input-area {
                padding: 0.75rem;
            }
            input[type=text] {
                padding: 0.6rem 0.9rem;
            }
            .send-btn {
                width: 40px;
                height: 40px;
            }
            footer {
                font-size: 0.8rem;
                padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div id="preloader"><div class="spinner"></div></div>
    <header class="text-center py-6 px-4 flex-shrink-0 bg-gradient-to-r from-pink-600 to-purple-700 text-white shadow-md animate-fade-in">
        <h1 class="text-3xl sm:text-4xl font-bold">Planet Beauty</h1>
        <p class="text-lg sm:text-xl">Your AI Beauty Assistant ✨</p>
    </header>

    <main class="chat-container flex-grow animate-fade-in">
        <div id="chat-area" class="chat-area">
            <div class="bot-message">Hi there! Welcome to Planet Beauty's AI Assistant. ✨ How can I help you find the perfect products today?</div>
            <div id="examples-container" class="examples-container"></div>
        </div>

        <div class="input-area">
            <div class="input-row">
                <input id="chat-input" type="text" placeholder="Ask about beauty products..." autocomplete="off" aria-label="Type your beauty product question">
                <button id="send-btn" class="send-btn" disabled aria-label="Send message"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </main>

    <footer>
        <span>Developed with ❤️ by</span>
        <a href="https://www.linkedin.com/in/joseespinosa" target="_blank" rel="noopener noreferrer">Jose Espinosa</a>
    </footer>

    <script>
        // --- Configuration ---
        const GEMINI_API_KEY = 'AIzaSyDLv0HUbLkt1mLf8_iWQnggj_8hof2ZMDs';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`; // Placeholder; currently using gemini-1.5-flash
        const API_TIMEOUT = 15000;
        const IMAGE_TIMEOUT = 5000;
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRX4zvphZLKZmYtDv2NC5RXHlgEl7pb7pzt91FhgCKi7NiDaeoYCvcXQ0zZt74BR5aTFc4ZVrAWi41x/pub?gid=875103365&single=true&output=csv'; // Replace with actual published CSV link from https://docs.google.com/spreadsheets/d/12wNendKIPoK5DnzL4oOdxyx5lAvSldwtZ0KJNO2cbG0/edit?usp=sharing

        // --- Fallback Questions ---
        const FALLBACK_QUESTIONS = [
            "What products are best for sensitive skin?",
            "Can you recommend a conditioner for curly hair?",
            "What's a good cleanser for combination skin?",
            "Which makeup is ideal for a natural look?"
        ];

        // --- State ---
        const userProfile = { skinType: null, skinTone: null, concerns: [] };
        let conversationHistory = [];
        const MAX_HISTORY = 6;
        const imageCache = JSON.parse(localStorage.getItem('imageCache')) || {};
        let products = []; // Dynamic product list
        let productCategories = {}; // Dynamic categories
        const backupImages = {
            default: 'https://via.placeholder.com/600x400/E91e63/FFFFFF?text=Planet+Beauty',
        };

        // --- Category Keywords ---
        const categoryKeywords = {
            acne: ['acne', 'blemish', 'pimple', 'breakout', 'clear skin', 'oily'],
            moisturizer: ['moisturizer', 'hydrating', 'dry skin', 'hydration', 'cream'],
            shampoo: ['shampoo', 'hair wash', 'clean hair'],
            conditioner: ['conditioner', 'soften hair', 'detangle'],
            hairmask: ['hair mask', 'treatment', 'damaged hair', 'repair hair'],
            foundation: ['foundation', 'makeup base', 'cover', 'complexion', 'tone'],
            serum: ['serum', 'treatment', 'concentrate'],
            cleanser: ['cleanser', 'face wash', 'wash'],
            exfoliant: ['exfoliant', 'scrub', 'peel', 'smooth skin'],
            styling: ['styling', 'hairspray', 'texture', 'volume', 'hold'],
            skincare: ['skincare', 'face care', 'complexion', 'skin health'],
            haircare: ['haircare', 'hair product', 'mane']
        };

        // --- DOM Elements ---
        const chatArea = document.getElementById('chat-area');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const preloader = document.getElementById('preloader');
        const examplesContainer = document.getElementById('examples-container');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            setTimeout(() => {
                preloader.style.opacity = '0';
                setTimeout(() => preloader.remove(), 500);
            }, 1000);

            anime({
                targets: 'header',
                translateY: [-20, 0],
                opacity: [0, 1],
                duration: 800,
                easing: 'easeOutQuad'
            });

            products = await fetchProducts();
            categorizeProducts();
            await generateSuggestedQuestions();

            chatInput.addEventListener('keyup', handleInputKeyup);
            chatInput.addEventListener('input', handleInputChange);
            sendBtn.addEventListener('click', () => {
                sendMessage();
                gtag('event', 'send_message', { event_category: 'Chatbot', event_label: chatInput.value });
            });
            chatInput.focus();
            updateSendButtonState();
            preloadImages();
        });

        // --- Fetch Products from Google Sheet ---
        async function fetchProducts() {
            try {
                const res = await axios.get(csvUrl);
                const data = Papa.parse(res.data, { header: true });
                products = data.data.map((row, index) => ({
                    id: `p${index + 1}`,
                    name: row['title'],
                    price: row['price'],
                    description: row['description'],
                    image: row['image link'],
                    url: row['link']
                })).filter(p => p.name && p.url); // Filter out invalid entries
                return products;
            } catch (error) {
                console.error('Failed to fetch products:', error);
                return [];
            }
        }

        // --- Categorize Products ---
        function categorizeProducts() {
            products.forEach(product => {
                product.categories = [];
                for (const [category, keywords] of Object.entries(categoryKeywords)) {
                    if (keywords.some(keyword => 
                        (product.name && product.name.toLowerCase().includes(keyword)) || 
                        (product.description && product.description.toLowerCase().includes(keyword)))) {
                        product.categories.push(category);
                    }
                }
            });
            productCategories = Object.fromEntries(
                Object.keys(categoryKeywords).map(category => [
                    category,
                    products.filter(p => p.categories.includes(category))
                ])
            );
            // Update backupImages with product images
            for (const category of Object.keys(productCategories)) {
                backupImages[category] = productCategories[category].map(p => p.image).filter(Boolean);
            }
        }

        // --- Suggested Questions ---
        async function generateSuggestedQuestions() {
            try {
                const questions = await fetchSuggestedQuestions();
                displaySuggestedQuestions(questions);
            } catch (error) {
                console.error('Failed to generate suggested questions:', error);
                displaySuggestedQuestions(FALLBACK_QUESTIONS);
            }
        }

        async function fetchSuggestedQuestions() {
            const prompt = {
                contents: [{
                    role: 'user',
                    parts: [{
                        text: `Generate 4 concise, varied, and helpful beauty-related questions for a chatbot. Questions should be relevant to skincare, haircare, or makeup, addressing common user needs (e.g., product recommendations for specific skin types or hair concerns). Return the response as a JSON array of strings. Example:
                        ["What's the best moisturizer for oily skin?", "Can you recommend a shampoo for dry hair?", "What foundation suits sensitive skin?", "Which serum helps with fine lines?"]`
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    topP: 0.95,
                    topK: 40,
                    maxOutputTokens: 256,
                    responseMimeType: 'application/json'
                },
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
                ]
            };

            const res = await axios.post(GEMINI_API_URL, prompt, {
                headers: { 'Content-Type': 'application/json' },
                timeout: API_TIMEOUT
            });

            if (res.data && res.data.candidates && res.data.candidates[0] &&
                res.data.candidates[0].content && res.data.candidates[0].content.parts &&
                res.data.candidates[0].content.parts[0] && res.data.candidates[0].content.parts[0].text) {
                const responseText = res.data.candidates[0].content.parts[0].text;
                try {
                    const questions = JSON.parse(responseText);
                    if (Array.isArray(questions) && questions.length >= 4) {
                        return questions.slice(0, 4);
                    }
                } catch (parseError) {
                    console.error('JSON Parse Error for questions:', parseError);
                }
            }
            throw new Error('Failed to fetch valid questions.');
        }

        function displaySuggestedQuestions(questions) {
            examplesContainer.innerHTML = '';
            questions.forEach((question, index) => {
                const chip = document.createElement('div');
                chip.className = 'example-chip';
                chip.setAttribute('data-q', question);
                chip.setAttribute('role', 'button');
                chip.setAttribute('aria-label', `Ask: ${question}`);
                chip.textContent = question;
                chip.addEventListener('click', handleExampleClick);
                chip.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') handleExampleClick(e);
                });
                examplesContainer.appendChild(chip);
            });

            anime({
                targets: '.example-chip',
                translateX: [-20, 0],
                opacity: [0, 1],
                delay: anime.stagger(100),
                duration: 600,
                easing: 'easeOutQuad'
            });
        }

        // --- Utilities ---
        function isValidImageUrl(url) {
            return new Promise((resolve) => {
                if (!url || typeof url !== 'string' || !url.match(/^https?:\/\/.*\.(jpg|jpeg|png|gif|webp)$/i)) {
                    return resolve(false);
                }
                if (imageCache[url] === true) return resolve(true);
                if (imageCache[url] === false) return resolve(false);
                const img = new Image();
                const timeout = setTimeout(() => {
                    img.src = '';
                    imageCache[url] = false;
                    localStorage.setItem('imageCache', JSON.stringify(imageCache));
                    resolve(false);
                }, IMAGE_TIMEOUT);
                img.onload = () => {
                    clearTimeout(timeout);
                    imageCache[url] = true;
                    localStorage.setItem('imageCache', JSON.stringify(imageCache));
                    resolve(true);
                };
                img.onerror = () => {
                    clearTimeout(timeout);
                    imageCache[url] = false;
                    localStorage.setItem('imageCache', JSON.stringify(imageCache));
                    resolve(false);
                };
                img.src = url;
            });
        }

        function formatProductUrl(productName) {
            if (!productName) return '#';
            return 'https://www.planetbeauty.com/products/' +
                productName.toLowerCase()
                    .replace(/[^\w\s-]/g, '')
                    .trim()
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-');
        }

        function getBackupImage(query) {
            const queryLower = query.toLowerCase();
            for (const [category, keywords] of Object.entries(categoryKeywords)) {
                if (keywords.some(keyword => queryLower.includes(keyword))) {
                    const imageArray = backupImages[category];
                    if (imageArray && imageArray.length > 0) {
                        return imageArray[Math.floor(Math.random() * imageArray.length)];
                    }
                }
            }
            return backupImages.default;
        }

        function preloadImages() {
            const preloadImages = products.map(p => p.image).filter(Boolean);
            preloadImages.forEach(src => {
                const link = document.createElement('link');
                link.rel = 'preload';
                link.as = 'image';
                link.href = src;
                document.head.appendChild(link);
            });
        }

        // --- Event Handlers ---
        function handleExampleClick(event) {
            const query = event.target.getAttribute('data-q');
            if (query) {
                chatInput.value = query;
                updateSendButtonState();
                sendMessage();
                gtag('event', 'example_chip_click', { event_category: 'Chatbot', event_label: query });
            }
        }

        function handleInputKeyup(event) {
            if (event.key === 'Enter' && !sendBtn.disabled) {
                sendMessage();
                gtag('event', 'send_message', { event_category: 'Chatbot', event_label: chatInput.value });
            }
        }

        function handleInputChange() {
            updateSendButtonState();
        }

        function updateSendButtonState() {
            sendBtn.disabled = chatInput.value.trim() === '';
        }

        // --- Core Functions ---
        async function sendMessage() {
            const rawMessage = chatInput.value.trim();
            if (!rawMessage) return;
            const message = DOMPurify.sanitize(rawMessage);

            addMessage(message, 'user');
            const userMessageEntry = { role: 'user', parts: [{ text: message }] };
            conversationHistory.push(userMessageEntry);

            chatInput.value = '';
            updateSendButtonState();
            chatInput.disabled = true;
            sendBtn.disabled = true;

            showTypingIndicator();

            try {
                const response = await callGeminiAPI(userMessageEntry);
                processResponse(response, message);
            } catch (error) {
                console.error('Error:', error);
                hideTypingIndicator();
                displayError("Sorry, I encountered an issue. Please try again or browse our products below:");
                const fallbackProducts = fallbackSearch(message);
                if (fallbackProducts.length > 0) {
                    fallbackProducts.forEach(p => addProductCard(p, message));
                } else {
                    addMessage("I couldn't find relevant products. Try another query!", 'bot');
                }
            } finally {
                chatInput.disabled = false;
                updateSendButtonState();
                chatInput.focus();
            }
        }

        async function callGeminiAPI(lastUserMessage) {
            if (conversationHistory.length > MAX_HISTORY) {
                conversationHistory = conversationHistory.slice(-MAX_HISTORY);
            }

            const prompt = createPrompt();
            const payload = {
                contents: prompt,
                generationConfig: {
                    temperature: 0.4,
                    topP: 0.95,
                    topK: 40,
                    maxOutputTokens: 1024,
                    responseMimeType: 'application/json'
                },
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
                ]
            };

            try {
                const res = await axios.post(GEMINI_API_URL, payload, {
                    headers: { 'Content-Type': 'application/json' },
                    timeout: API_TIMEOUT
                });

                if (res.data && res.data.candidates && res.data.candidates[0] &&
                    res.data.candidates[0].content && res.data.candidates[0].content.parts &&
                    res.data.candidates[0].content.parts[0] && res.data.candidates[0].content.parts[0].text) {
                    const responseText = res.data.candidates[0].content.parts[0].text;
                    let parsedResponse;
                    try {
                        parsedResponse = JSON.parse(responseText);
                        conversationHistory.push({ role: 'model', parts: [{ text: responseText }] });
                        return parsedResponse;
                    } catch (parseError) {
                        console.error('JSON Parse Error:', parseError);
                        const fallbackResponse = { text: responseText, query_type: 'other', products: [] };
                        conversationHistory.push({ role: 'model', parts: [{ text: responseText }] });
                        return fallbackResponse;
                    }
                } else if (res.data && res.data.promptFeedback && res.data.promptFeedback.blockReason) {
                    throw new Error(`Request blocked: ${res.data.promptFeedback.blockReason}. Please rephrase your query.`);
                } else {
                    throw new Error('Unexpected response format.');
                }
            } catch (error) {
                if (error.response) {
                    throw new Error(`API Error: ${error.response.status} - ${error.response.data?.error?.message || 'Unknown error'}`);
                } else if (error.request) {
                    throw new Error('Request timed out.');
                } else {
                    throw new Error(`Request error: ${error.message}`);
                }
            }
        }

        function createPrompt() {
            const systemInstruction = {
                role: 'user',
                parts: [{
                    text: `You are a friendly AI assistant for Planet Beauty. Your goal is to assist users with beauty product queries and engage in natural conversation. For each user message, determine the query type and respond accordingly.

- If the user is greeting or engaging in casual conversation (e.g., "hi," "hello," "how are you"), set "query_type": "greeting" and respond with a friendly message without recommending products.
- If the user is asking for product recommendations or mentioning a beauty concern, set "query_type": "product" and provide a concise response (max 150 words) along with 1-3 product recommendations in the "products" array.
- For other types of messages, set "query_type": "other" and respond appropriately.

Always include "text", "query_type", and "products" in your JSON response. Use conversation history for context.

Examples:
1. User: Hi
Assistant: {"text": "Hello! How can I assist you with your beauty needs today?", "query_type": "greeting", "products": []}
2. User: I need a moisturizer for dry skin
Assistant: {"text": "For dry skin, try these: ✨", "query_type": "product", "products": [{"name": "CeraVe Moisturizing Cream", "description": "Rich cream with ceramides.", "price": "$17.99", "image": "https://www.cerave.com/image.png", "url": "https://www.planetbeauty.com/products/cerave-moisturizing-cream"}]}
3. User: Thank you!
Assistant: {"text": "You're welcome! Anything else I can help with?", "query_type": "other", "products": []}
4. User: Bye
Assistant: {"text": "Goodbye! Have a beautiful day!", "query_type": "greeting", "products": []}
5. User: Hi, can you recommend a shampoo for oily hair?
Assistant: {"text": "Hi! For oily hair, try these shampoos: ✨", "query_type": "product", "products": [{"name": "Olaplex No. 4 Bond Maintenance Shampoo", "description": "Repairs and strengthens hair bonds.", "price": "$30.00", "image": "https://olaplex.com/image.png", "url": "https://www.planetbeauty.com/products/olaplex-no-4-bond-maintenance-shampoo"}]}`
                }]
            };
            return [systemInstruction, ...conversationHistory];
        }

        function fallbackSearch(query) {
            const queryLower = query.toLowerCase();
            const keywords = queryLower.split(/\s+/).filter(word => word.length > 2 && !['the', 'a', 'an', 'is', 'for', 'what', 'can', 'you', 'recommend', 'find', 'me', 'i', 'need'].includes(word));

            let categoryMatches = [];
            for (const [category, catKeywords] of Object.entries(categoryKeywords)) {
                if (catKeywords.some(kw => queryLower.includes(kw))) {
                    const categoryProducts = productCategories[category] || [];
                    categoryProducts.forEach(product => {
                        if (!categoryMatches.some(pm => pm.id === product.id)) {
                            categoryMatches.push(product);
                        }
                    });
                }
            }
            if (categoryMatches.length >= 2) return categoryMatches.slice(0, 3);

            const scoredProducts = products.map(product => {
                let score = 0;
                const nameLower = product.name.toLowerCase();
                const descLower = product.description.toLowerCase();
                if (categoryMatches.some(pm => pm.id === product.id)) score += 5;
                keywords.forEach(term => {
                    if (nameLower.includes(term)) score += 3;
                    if (descLower.includes(term)) score += 1;
                });
                return { product, score };
            });

            const relevantProducts = scoredProducts
                .filter(item => item.score > 0)
                .sort((a, b) => b.score - a.score)
                .map(item => item.product);

            const combined = [...categoryMatches];
            relevantProducts.forEach(p => {
                if (!combined.some(cp => cp.id === p.id)) combined.push(p);
            });

            return combined.slice(0, 3);
        }

        function processResponse(response, userQuery) {
            hideTypingIndicator();

            if (response && response.text) {
                addMessage(DOMPurify.sanitize(response.text), 'bot');
                updateUserProfile(response.text);
            } else {
                addMessage("Here's what I found:", 'bot');
            }

            let productsToShow = [];
            const queryType = response.query_type || 'other';

            if (response && response.products && response.products.length > 0) {
                productsToShow = response.products.map(p => ({
                    name: p.name || "Unknown Product",
                    description: p.description || "No description available.",
                    price: p.price || "Price not available",
                    image: p.image || getBackupImage(p.name || userQuery),
                    url: p.url && p.url.startsWith('https://www.planetbeauty.com/products/') ? p.url : formatProductUrl(p.name),
                    id: products.find(prod => prod.name === p.name)?.id || `api-${Date.now()}`
                }));
            } else if (queryType === 'product') {
                console.log("API returned no products for product query, using fallback search.");
                productsToShow = fallbackSearch(userQuery);
                if (productsToShow.length === 0) {
                    addMessage("I couldn't find specific products for that, but perhaps browse our categories?", 'bot');
                }
            }

            if (productsToShow.length > 0) {
                productsToShow.forEach(p => addProductCard(p, userQuery));
            }
        }

        // --- UI Functions ---
        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = sender === 'user' ? 'user-message' : 'bot-message';
            div.innerHTML = text;
            chatArea.appendChild(div);
            anime({
                targets: div,
                translateX: sender === 'user' ? [20, 0] : [-20, 0],
                opacity: [0, 1],
                duration: 400,
                easing: 'easeOutQuad'
            });
            scrollToBottom();
        }

        function showTypingIndicator() {
            hideTypingIndicator();
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'bot-message';
            div.innerHTML = '<span>Thinking</span><span class="typing-dots">.</span>';
            chatArea.appendChild(div);
            scrollToBottom();
            let dotCount = 1;
            const intervalId = setInterval(() => {
                dotCount = (dotCount % 3) + 1;
                div.querySelector('.typing-dots').textContent = '.'.repeat(dotCount);
            }, 400);
            div.dataset.intervalId = intervalId;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                const intervalId = indicator.dataset.intervalId;
                if (intervalId) clearInterval(parseInt(intervalId));
                indicator.remove();
            }
        }

        function displayError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = DOMPurify.sanitize(`
                ${message}
                <button class="retry-btn mt-2 text-pink-600 underline" aria-label="Retry request">Try Again</button>
            `);
            errorDiv.querySelector('.retry-btn').addEventListener('click', () => {
                if (chatInput.value.trim()) sendMessage();
            });
            chatArea.appendChild(errorDiv);
            scrollToBottom();
        }

        async function addProductCard(p, queryContext) {
            const card = document.createElement('a');
            card.href = p.url || formatProductUrl(p.name);
            card.target = '_blank';
            card.rel = 'noopener noreferrer';
            card.className = 'product-card';
            card.addEventListener('click', () => {
                gtag('event', 'product_click', { event_category: 'Chatbot', event_label: p.name });
            });

            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-loading';
            const spinner = document.createElement('div');
            spinner.className = 'spinner';
            imageContainer.appendChild(spinner);
            card.appendChild(imageContainer);

            const img = document.createElement('img');
            img.alt = p.name || "Product Image";
            img.className = 'product-image lazyload';
            img.dataset.src = p.image || getBackupImage(p.name || queryContext);
            img.style.display = 'none';

            const imageSources = [
                p.image,
                getBackupImage(p.name || queryContext),
                backupImages.default
            ].filter(url => url && typeof url === 'string' && url.trim() !== '');

            let currentAttempt = 0;
            const tryLoadNextImage = async () => {
                if (currentAttempt >= imageSources.length) {
                    console.warn(`Failed to load any image for product: ${p.name}`);
                    imageContainer.innerHTML = `
                        <div class="image-placeholder">
                            <span>Image Unavailable</span>
                        </div>`;
                    return;
                }
                const url = imageSources[currentAttempt];
                if (await isValidImageUrl(url)) {
                    img.dataset.src = url;
                    img.classList.add('lazyload');
                    if (img.classList.contains('lazyloaded')) {
                        imageContainer.replaceWith(img);
                        img.style.display = 'block';
                    }
                } else {
                    currentAttempt++;
                    tryLoadNextImage();
                }
            };

            img.addEventListener('load', () => {
                imageContainer.replaceWith(img);
                img.style.display = 'block';
            });

            img.addEventListener('error', () => {
                console.warn(`Image failed to load: ${img.dataset.src}`);
                currentAttempt++;
                tryLoadNextImage();
            });

            await tryLoadNextImage();

            const infoDiv = document.createElement('div');
            infoDiv.className = 'product-info';
            infoDiv.innerHTML = DOMPurify.sanitize(`
                <div class="product-name">${p.name || "Unnamed Product"}</div>
                <div class="product-description">${p.description || "Click for details."}</div>
                <div class="product-price">${p.price || ""}</div>
            `);
            card.appendChild(infoDiv);
            chatArea.appendChild(card);
            scrollToBottom();
        }

        function scrollToBottom() {
            requestAnimationFrame(() => {
                chatArea.scrollTop = chatArea.scrollHeight;
            });
        }

        function updateUserProfile(botResponseText) {
            const textLower = botResponseText.toLowerCase();
            if (textLower.includes('dry skin')) userProfile.skinType = 'Dry';
            if (textLower.includes('oily skin')) userProfile.skinType = 'Oily';
            if (textLower.includes('acne')) userProfile.concerns.push('Acne');
            console.log('Updated Profile:', userProfile);
        }
    </script>
</body>
</html>
