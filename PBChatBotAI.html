<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Planet Beauty AI Chatbot - Discover personalized beauty products with our smart assistant.">
    <link rel="icon" href="https://placehold.co/16x16/E91e63/FFFFFF?text=PB" type="image/png" onerror="this.href='/images/favicon.png';">
    <title>Planet Beauty AI Chatbot</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DLVD913P7M"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-DLVD913P7M');
    </script>
    <style>
        :root {
            --primary: #e91e63;
            --primary-dark: #c2185b;
            --bg-light: #f8f9fa;
            --bg-dark: #1f2937;
            --text-light: #1f2937;
            --text-dark: #f3f4f6;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            margin: 0;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark-mode {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        .dark-mode #preloader {
            background: var(--bg-dark);
        }
        #preloader .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--primary);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        #preloader .percentage {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--primary);
        }
        .chat-container {
            max-width: 800px;
            margin: 1rem auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 16px;
            background: white;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
            max-height: 900px;
            overflow: hidden;
        }
        .dark-mode .chat-container {
            background: #374151;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .chat-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            scroll-behavior: smooth;
        }
        .dark-mode .chat-area {
            background: #374151;
        }
        .user-message {
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 12px 12px 0 12px;
            max-width: 75%;
            margin-left: auto;
            margin-bottom: 0.75rem;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .bot-message {
            background: #e5e7eb;
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: 12px 12px 12px 0;
            max-width: 75%;
            margin-right: auto;
            margin-bottom: 0.75rem;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .dark-mode .bot-message {
            background: #4b5563;
            color: var(--text-dark);
        }
        .product-section {
            background: #f1f5f9;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            max-width: 90%;
            margin-right: auto;
        }
        .dark-mode .product-section {
            background: #4b5563;
        }
        .product-card {
            display: flex;
            align-items: center;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 0.5rem 0;
            text-decoration: none;
            color: inherit;
            background: white;
            max-width: 100%;
            cursor: pointer;
            border: 1px solid #e5e7eb;
        }
        .dark-mode .product-card {
            background: #6b7280;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            border-color: #4b5563;
        }
        .product-card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            flex-shrink: 0;
            border-radius: 8px;
            margin: 0.5rem;
        }
        .lazyload, .lazyloading {
            opacity: 0;
            transition: opacity 0.3s;
        }
        .lazyloaded {
            opacity: 1;
        }
        .image-placeholder {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #eee;
            color: #666;
            font-size: 0.75rem;
            text-align: center;
            border-radius: 8px;
            margin: 0.5rem;
            flex-shrink: 0;
        }
        .dark-mode .image-placeholder {
            background: #6b7280;
            color: #d1d5db;
        }
        .product-info {
            padding: 0.5rem;
            flex-grow: 1;
        }
        .product-name {
            font-weight: 500;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .product-description {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dark-mode .product-description {
            color: #d1d5db;
        }
        .product-price {
            font-weight: 500;
            font-size: 0.8rem;
            color: var(--primary);
        }
        .examples-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            max-width: 90%;
        }
        .example-chip {
            padding: 0.4rem 0.8rem;
            background: #e5e7eb;
            border: 1px solid #d1d5db;
            border-radius: 16px;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.3s, box-shadow 0.2s;
            font-size: 0.85rem;
        }
        .dark-mode .example-chip {
            background: #4b5563;
            border-color: #6b7280;
            color: var(--text-dark);
        }
        .example-chip:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .example-chip:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        .input-area {
            display: flex;
            padding: 0.75rem;
            border-top: 1px solid #e5e7eb;
            background: white;
            align-items: center;
            gap: 0.5rem;
        }
        .dark-mode .input-area {
            background: #374151;
            border-top-color: #4b5563;
        }
        .input-row {
            display: flex;
            gap: 8px;
            flex-grow: 1;
        }
        input[type=text] {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            outline: none;
            transition: border-color 0.3s;
            font-size: 0.9rem;
        }
        .dark-mode input[type=text] {
            background: #4b5563;
            border-color: #6b7280;
            color: var(--text-dark);
        }
        input[type=text]:focus {
            border-color: var(--primary);
        }
        input[type=text]:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }
        .dark-mode input[type=text]:disabled {
            background-color: #6b7280;
        }
        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            flex-shrink: 0;
        }
        .send-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }
        .send-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }
        .theme-toggle {
            background: #e5e7eb;
            color: var(--text-light);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .dark-mode .theme-toggle {
            background: #4b5563;
            color: var(--text-dark);
        }
        .theme-toggle:hover {
            background: var(--primary);
            color: white;
        }
        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            max-width: 75%;
            margin-right: auto;
            border: 1px solid #fecaca;
            font-size: 0.85rem;
        }
        .dark-mode .error-message {
            background: #7f1d1d;
            color: #f87171;
            border-color: #b91c1c;
        }
        .retry-btn {
            background: none;
            border: none;
            color: var(--primary);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.85rem;
        }
        footer {
            background: white;
            padding: 0.5rem 1rem;
            color: #6b7280;
            font-size: 0.8rem;
            text-align: center;
            flex-shrink: 0;
        }
        .dark-mode footer {
            background: #374151;
            color: #d1d5db;
        }
        footer a {
            color: var(--primary);
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
        #typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.85rem;
        }
        #typing-indicator .dot {
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            display: inline-block;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        .dot-1 { animation: bounce 0.5s infinite; }
        .dot-2 { animation: bounce 0.5s infinite 0.15s; }
        .dot-3 { animation: bounce 0.5s infinite 0.3s; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        #debug-panel {
            position: fixed;
            bottom: 0;
            right: 0;
            background: rgba(31, 41, 55, 0.9);
            color: #f3f4f6;
            padding: 0.75rem;
            max-width: 280px;
            max-height: 250px;
            overflow: auto;
            font-size: 0.75rem;
            z-index: 1000;
            border-top-left-radius: 8px;
            display: none;
        }
        .debug-entry {
            padding: 0.4rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .debug-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            margin-top: 0.4rem;
            cursor: pointer;
            font-size: 0.75rem;
        }
        @media (max-width: 640px) {
            body { padding: 0; }
            .chat-container {
                margin: 0;
                border-radius: 0;
                max-width: 100%;
                height: 100vh;
                max-height: none;
            }
            .chat-area { padding: 0.75rem; }
            .user-message, .bot-message, .product-section, .examples-container, .error-message {
                max-width: 85%;
            }
            .input-area { padding: 0.5rem; }
            input[type=text] { padding: 0.4rem 0.6rem; font-size: 0.85rem; }
            .send-btn, .theme-toggle { width: 32px; height: 32px; }
            footer { font-size: 0.75rem; padding-bottom: calc(0.5rem + env(safe-area-inset-bottom)); }
            #debug-panel { max-width: 90%; }
            .product-image, .image-placeholder {
                width: 60px;
                height: 60px;
                margin: 0.4rem;
            }
            .product-name { font-size: 0.8rem; }
            .product-description { font-size: 0.7rem; -webkit-line-clamp: 1; }
            .product-price { font-size: 0.75rem; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div id="preloader">
        <div class="spinner"></div>
        <div class="percentage">0%</div>
    </div>
    <header class="text-center py-4 px-4 flex-shrink-0 bg-gradient-to-r from-pink-600 to-purple-700 text-white shadow-md animate-fade-in">
        <h1 class="text-2xl sm:text-3xl font-semibold">Planet Beauty</h1>
        <p class="text-base sm:text-lg">Your AI Beauty Assistant ✨</p>
    </header>
    <main class="chat-container flex-grow animate-fade-in">
        <div id="chat-area" class="chat-area">
            <div class="bot-message">Hello! Welcome to Planet Beauty. I'm here to help with your beauty needs or just chat about what's on your mind. How can I assist you today? 😊</div>
            <div id="examples-container" class="examples-container"></div>
        </div>
        <div class="input-area">
            <div class="input-row">
                <input id="chat-input" type="text" placeholder="Ask about beauty products or chat..." autocomplete="off" aria-label="Type your beauty question or chat">
                <button id="send-btn" class="send-btn" disabled aria-label="Send message"><i class="fas fa-paper-plane"></i></button>
            </div>
            <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode"><i class="fas fa-moon"></i></button>
        </div>
    </main>
    <footer>
        <span>Developed with ❤️ by</span>
        <a Principled
        <a href="https://www.linkedin.com/in/joseespinosa" target="_blank" rel="noopener noreferrer">Jose Espinosa</a>
    </footer>
    <div id="debug-panel">
        <h3 class="font-semibold mb-1.5">Debug Information</h3>
        <div id="debug-content"></div>
        <button id="debug-clear" class="debug-button">Clear</button>
        <button id="debug-close" class="debug-button ml-1.5">Close</button>
    </div>
    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx544DSP6TmyBkWzqtU41be9PqpRNY444Tx_G7wIkLnay9PlHpnTN514Vt4OsgxLHyc/exec';
        const API_TIMEOUT = 20000;
        const PLANET_BEAUTY_DOMAIN = 'https://www.planetbeauty.com';
        const DEBUG_MODE = true;
        const RATE_LIMIT_MS = 1000;

        const FALLBACK_QUESTIONS = [
            "What shampoo is best for dry, color-treated hair?",
            "Can you suggest a cleanser for oily, acne-prone skin?",
            "Which products are best for someone with low vision?",
            "What are the top 20 beauty products for 2025?",
            "Do you have any LED masks for anti-aging?"
        ];

        let conversationHistory = [];
        let lastRecommendedProducts = [];
        let lastMessageTime = 0;

        const chatArea = document.getElementById('chat-area');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const preloader = document.getElementById('preloader');
        const examplesContainer = document.getElementById('examples-container');
        const debugPanel = document.getElementById('debug-panel');
        const debugContent = document.getElementById('debug-content');
        const themeToggle = document.getElementById('theme-toggle');

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            themeToggle.innerHTML = `<i class="fas fa-${isDark ? 'sun' : 'moon'}"></i>`;
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            if (typeof gtag === 'function') {
                gtag('event', 'theme_toggle', { event_category: 'UI', event_label: isDark ? 'dark' : 'light' });
            }
        });

        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        }

        function debugLog(message, data) {
            if (!DEBUG_MODE) return;
            console.log(`[DEBUG] ${message}`, data);
            const entry = document.createElement('div');
            entry.className = 'debug-entry';
            const timestamp = new Date().toLocaleTimeString();
            let content = `<strong>[${timestamp}]</strong> ${message}`;
            if (data !== undefined) {
                if (typeof data === 'object') {
                    try {
                        content += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    } catch (e) {
                        content += `<pre>[Object]</pre>`;
                    }
                } else {
                    content += ` ${data}`;
                }
            }
            entry.innerHTML = content;
            debugContent.appendChild(entry);
            debugPanel.scrollTop = debugPanel.scrollHeight;
            if (DEBUG_MODE && debugPanel.style.display === 'none') {
                debugPanel.style.display = 'block';
            }
        }

        document.getElementById('debug-clear').addEventListener('click', () => {
            debugContent.innerHTML = '';
        });

        document.getElementById('debug-close').addEventListener('click', () => {
            debugPanel.style.display = 'none';
        });

        function safeEncodeURIComponent(str) {
            try {
                return encodeURIComponent(str).replace(/[!'()*]/g, escape);
            } catch (e) {
                debugLog('URL encoding error', { error: e.message });
                return '';
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            let percentage = 0;
            const percentageElement = preloader.querySelector('.percentage');
            const animatePercentage = () => {
                return new Promise(resolve => {
                    anime({
                        targets: { value: percentage },
                        value: 90,
                        duration: 1500,
                        easing: 'easeOutQuad',
                        update: (anim) => {
                            percentage = Math.round(anim.animatables[0].target.value);
                            percentageElement.textContent = `${percentage}%`;
                        },
                        complete: () => resolve()
                    });
                });
            };

            const minDurationPromise = new Promise(resolve => setTimeout(resolve, 800));
            const maxDurationPromise = new Promise(resolve => setTimeout(resolve, 8000));
            const animationPromise = animatePercentage();
            let initializationSuccess = true;

            try {
                debugLog('Initializing Planet Beauty AI Assistant');
                await new Promise(resolve => setTimeout(resolve, 800));
            } catch (error) {
                console.error('Initialization error:', error);
                debugLog('Initialization error', error);
                percentageElement.textContent = 'Error';
                percentageElement.style.color = '#dc2626';
                addMessage("Sorry, I couldn't initialize properly. Please refresh the page.", 'bot');
                initializationSuccess = false;
            } finally {
                try {
                    await generateSuggestedQuestions();
                } catch (error) {
                    debugLog('Failed to generate suggested questions during init', error);
                }
                await Promise.race([Promise.all([minDurationPromise, animationPromise]), maxDurationPromise]);
                await anime({
                    targets: { value: percentage },
                    value: 100,
                    duration: 200,
                    easing: 'easeOutQuad',
                    update: (anim) => {
                        percentageElement.textContent = `${Math.round(anim.animatables[0].target.value)}%`;
                    }
                }).finished;
                preloader.style.opacity = '0';
                setTimeout(() => {
                    if (preloader && preloader.parentNode) {
                        preloader.remove();
                        debugLog('Preloader removed', { timedOut: !initializationSuccess });
                    }
                }, 400);
            }

            anime({
                targets: 'header',
                translateY: [-15, 0],
                opacity: [0, 1],
                duration: 600,
                easing: 'easeOutQuad'
            });

            chatInput.addEventListener('keyup', handleInputKeyup);
            chatInput.addEventListener('input', handleInputChange);
            sendBtn.addEventListener('click', () => {
                sendMessage();
                if (typeof gtag === 'function') {
                    gtag('event', 'send_message', { event_category: 'Chatbot', event_label: chatInput.value });
                }
            });
            chatInput.focus();
            updateSendButtonState();
        });

        async function generateSuggestedQuestions() {
            try {
                const questions = await fetchSuggestedQuestions();
                displaySuggestedQuestions(questions);
            } catch (error) {
                console.error('Failed to generate suggested questions:', error);
                debugLog('Suggested questions error', error);
                displaySuggestedQuestions(FALLBACK_QUESTIONS);
            }
        }

        async function fetchSuggestedQuestions() {
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyCpI-eNfqWk_ZiK2qHOj_tD2NzeAJ_U398`;
            const prompt = {
                contents: [{
                    role: 'user',
                    parts: [{
                        text: `Generate 5 concise, varied beauty-related questions for a chatbot exclusive to Planet Beauty (${PLANET_BEAUTY_DOMAIN}). Questions MUST focus on products likely available in the Planet Beauty catalog and address specific user concerns (e.g., skin type, accessibility, devices, 2025 trends like sustainability or inclusivity). Return ONLY a valid JSON array of 5 strings.`
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    topP: 0.95,
                    topK: 40,
                    maxOutputTokens: 256,
                    responseMimeType: 'application/json'
                },
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
                ]
            };

            try {
                const res = await axios.post(GEMINI_API_URL, prompt, {
                    headers: { 'Content-Type': 'application/json' },
                    timeout: API_TIMEOUT
                });

                if (res.data?.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const responseText = res.data.candidates[0].content.parts[0].text;
                    try {
                        const cleanedText = responseText.replace(/^```json\s*|```$/g, '').trim();
                        const questions = JSON.parse(cleanedText);
                        if (Array.isArray(questions) && questions.length >= 5 && questions.every(q => typeof q === 'string' && q.trim())) {
                            return questions.slice(0, 5);
                        }
                        throw new Error('Invalid questions format');
                    } catch (parseError) {
                        console.error('JSON Parse Error:', parseError, 'Raw text:', responseText);
                        debugLog('Suggested questions JSON parse error', { error: parseError.message, raw: responseText });
                        return FALLBACK_QUESTIONS;
                    }
                }
                throw new Error('No valid response from API');
            } catch (error) {
                debugLog('Suggested questions fetch error', { error: error.message });
                return FALLBACK_QUESTIONS;
            }
        }

        function displaySuggestedQuestions(questions) {
            examplesContainer.innerHTML = '';
            if (!Array.isArray(questions)) {
                console.error("Cannot display suggestions: not an array.", questions);
                questions = FALLBACK_QUESTIONS;
            }
            questions.forEach((question, index) => {
                if (typeof question !== 'string' || !question.trim()) {
                    console.warn(`Skipping invalid suggestion at index ${index}:`, question);
                    return;
                }
                const chip = document.createElement('div');
                chip.className = 'example-chip';
                chip.setAttribute('data-q', question);
                chip.setAttribute('role', 'button');
                chip.tabIndex = 0;
                chip.setAttribute('aria-label', `Ask: ${question}`);
                chip.textContent = question;
                chip.addEventListener('click', handleExampleClick);
                chip.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        handleExampleClick(e);
                    }
                });
                examplesContainer.appendChild(chip);
            });

            anime({
                targets: '.example-chip',
                translateX: [-15, 0],
                opacity: [0, 1],
                delay: anime.stagger(80),
                duration: 500,
                easing: 'easeOutQuad'
            });
        }

        function handleExampleClick(event) {
            const query = event.currentTarget.getAttribute('data-q');
            if (query) {
                chatInput.value = query;
                updateSendButtonState();
                sendMessage();
                if (typeof gtag === 'function') {
                    gtag('event', 'example_chip_click', { event_category: 'Chatbot', event_label: query });
                }
            }
        }

        function handleInputKeyup(event) {
            if (event.key === 'Enter' && !sendBtn.disabled) {
                sendMessage();
                if (typeof gtag === 'function') {
                    gtag('event', 'send_message_enter', { event_category: 'Chatbot', event_label: chatInput.value });
                }
            }
        }

        function handleInputChange() {
            updateSendButtonState();
        }

        function updateSendButtonState() {
            sendBtn.disabled = chatInput.value.trim() === '';
        }

        function getConversationHistory() {
            const history = [];
            const messages = chatArea.querySelectorAll('.user-message, .bot-message');
            for (let i = Math.max(0, messages.length - 12); i < messages.length; i++) {
                const msg = messages[i];
                const role = msg.classList.contains('user-message') ? 'user' : 'assistant';
                const content = msg.textContent;
                const entry = { role, content };
                if (role === 'assistant' && i === messages.length - 1 && lastRecommendedProducts.length > 0) {
                    entry.products = lastRecommendedProducts;
                }
                history.push(entry);
            }
            return history;
        }

        async function sendMessage() {
            const now = Date.now();
            if (now - lastMessageTime < RATE_LIMIT_MS) {
                displayError("Please wait a moment before sending another message.");
                return;
            }
            lastMessageTime = now;

            const rawMessage = chatInput.value.trim();
            if (!rawMessage) return;

            const message = DOMPurify.sanitize(rawMessage, { USE_PROFILES: { html: false } });
            addMessage(message, 'user');

            conversationHistory = getConversationHistory();
            debugLog('Conversation history sent', conversationHistory);

            chatInput.value = '';
            updateSendButtonState();
            chatInput.disabled = true;
            sendBtn.disabled = true;

            showTypingIndicator();

            try {
                const encodedHistory = safeEncodeURIComponent(JSON.stringify(conversationHistory));
                const res = await axios.get(`${WEB_APP_URL}?action=search&query=${encodeURIComponent(message)}&conversationHistory=${encodedHistory}`, {
                    timeout: API_TIMEOUT
                });
                const { text, products, query_type, search_criteria } = res.data;
                debugLog('Search response', { query_type, text, product_count: products.length, products: products.map(p => p.name), search_criteria });
                hideTypingIndicator();
                addMessage(text, 'bot');
                conversationHistory.push({ role: 'assistant', content: text, products });
                if (products && products.length > 0) {
                    lastRecommendedProducts = products.map(p => ({ name: p.name, brand: p.brand, category: p.category }));
                    debugLog('Updated lastRecommendedProducts', lastRecommendedProducts);
                    addProductSection(products, message);
                }
            } catch (error) {
                console.error('Error during message processing:', error);
                debugLog('Message processing error', { error: error.message });
                hideTypingIndicator();
                let errorMessage = "I encountered an issue. Please try again.";
                if (error.message.includes('timed out')) {
                    errorMessage = "The request timed out. Check your connection and try again.";
                } else if (error.message.includes('Invalid')) {
                    errorMessage = "Please clarify your request, like specifying a product type (e.g., skincare or makeup).";
                }
                displayError(errorMessage);
            } finally {
                chatInput.disabled = false;
                updateSendButtonState();
                chatInput.focus();
            }
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === 'user' ? 'user-message animate-fade-in' : 'bot-message animate-fade-in';
            messageDiv.innerHTML = DOMPurify.sanitize(text);
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'bot-message animate-fade-in';
            typingDiv.innerHTML = '<span>Thinking</span><span class="dot dot-1"></span><span class="dot dot-2"></span><span class="dot dot-3"></span>';
            chatArea.appendChild(typingDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingDiv = document.getElementById('typing-indicator');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        function displayError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message animate-fade-in';
            errorDiv.innerHTML = DOMPurify.sanitize(`${message} <button class="retry-btn" onclick="document.getElementById('chat-input').focus()">Retry</button>`);
            chatArea.appendChild(errorDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function addProductSection(products, query) {
            debugLog('Displaying products for query', { query, products: products.map(p => p.name) });
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'product-section animate-fade-in';
            sectionDiv.innerHTML = '<div class="font-semibold text-sm mb-2">Recommended Products:</div>';
            products.forEach((product, index) => {
                const card = document.createElement('a');
                card.href = product.url;
                card.className = 'product-card';
                card.setAttribute('target', '_blank');
                card.setAttribute('rel', 'noopener noreferrer');
                card.setAttribute('aria-label', `View ${product.name} on Planet Beauty`);

                let imageHtml = `<div class="image-placeholder">Image not available</div>`;
                if (product.image) {
                    imageHtml = `<img src="${product.image}" alt="${product.name}" class="product-image lazyload">`;
                }

                const truncatedName = product.name.length > 50 ? product.name.substring(0, 47) + '...' : product.name;
                const truncatedDescription = product.description && product.description.length > 100 ? product.description.substring(0, 97) + '...' : product.description || 'No description available';

                card.innerHTML = `
                    ${imageHtml}
                    <div class="product-info">
                        <div class="product-name">${DOMPurify.sanitize(truncatedName)}</div>
                        <div class="product-description">${DOMPurify.sanitize(truncatedDescription)}</div>
                        <div class="product-price">${DOMPurify.sanitize(product.price || 'Price not available')}</div>
                    </div>
                `;
                sectionDiv.appendChild(card);

                card.addEventListener('click', (e) => {
                    if (!card.href) {
                        e.preventDefault();
                        debugLog('Product card click failed: missing URL', { product: product.name });
                    }
                    if (typeof gtag === 'function') {
                        gtag('event', 'product_card_click', { event_category: 'Chatbot', event_label: product.name });
                    }
                });
            });
            chatArea.appendChild(sectionDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
    </script>
</body>
</html>
