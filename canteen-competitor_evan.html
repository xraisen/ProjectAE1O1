<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canteen Canada: Strategic Market Analysis</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Chosen Palette: Warm Neutrals -->

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fafaf9; /* Stone-50 */
            color: #292524; /* Stone-800 */
        }
        
        /* Custom Scrollbar for cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f5f5f4; 
        }
        ::-webkit-scrollbar-thumb {
            background: #d6d3d1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a29e; 
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .transition-all-300 {
            transition: all 0.3s ease-in-out;
        }

        /* Chart Container Styling - Mandatory per requirements */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Max width to prevent stretching */
            height: 300px;    /* Base height */
            max-height: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        .nav-btn.active {
            background-color: #292524;
            color: #ffffff;
        }
        
        .ad-copy-preview {
            border: 2px solid #3b82f6; /* Blue border for Google Ad look */
            background-color: #eff6ff; /* Blue-50 background */
        }
        .ad-url {
            color: #16a34a; /* Green-600 for display URL */
            font-weight: 500;
        }
        .ad-headline {
            color: #1d4ed8; /* Blue-700 for headline */
            font-weight: 700;
        }
    </style>

</head>
<body class="antialiased selection:bg-stone-200 selection:text-stone-900">

    <!-- Navigation / Header (Updated for Attribution and Context) -->
    <header class="bg-white border-b border-stone-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight text-stone-900">Competitive Analysis: Canteen Canada</h1>
                <p class="text-xs text-stone-500 uppercase tracking-wide">Prepared by Jose Espinosa for Vending Machine Canada (Evan the Owner)</p>
            </div>
            <nav class="hidden md:flex space-x-1">
                <button onclick="scrollToSection('landscape')" class="px-3 py-2 text-sm font-medium text-stone-600 hover:text-stone-900 rounded-md transition-colors">Competitors</button>
                <button onclick="scrollToSection('search')" class="px-3 py-2 text-sm font-medium text-stone-600 hover:text-stone-900 rounded-md transition-colors">Search Terms</button>
                <button onclick="scrollToSection('ppc')" class="px-3 py-2 text-sm font-medium text-stone-600 hover:text-stone-900 rounded-md transition-colors">PPC Strategy</button>
                <button onclick="scrollToSection('insights')" class="px-3 py-2 text-sm font-medium text-stone-600 hover:text-stone-900 rounded-md transition-colors">Insights</button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-16">

        <!-- Introduction Section (Updated for Context) -->
        <section class="text-center max-w-3xl mx-auto space-y-4">
            <h2 class="text-3xl font-bold text-stone-800">Strategic Intelligence Dashboard: Analyzing a Major Competitor</h2>
            <p class="text-lg text-stone-600 leading-relaxed">
                This interactive report fulfills Evan’s request to analyze a key competitor, Canteen Canada. 
                We examine their market positioning, decode their high-value search terms, and reverse-engineer their potential PPC and SEO strategies. **Crucially, the following PPC strategy section is tailored to build Vending Machine Canada's (VMC) aggressive counter-campaigns.**
            </p>
            <div class="flex flex-wrap justify-center gap-2 mt-4">
                <span class="bg-stone-100 text-stone-600 px-3 py-1 rounded-full text-sm font-medium">Competitor Analysis</span>
                <span class="bg-stone-100 text-stone-600 px-3 py-1 rounded-full text-sm font-medium">Search Term Strategy</span>
                <span class="bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-sm font-medium">VMC Counter-Strategy</span>
            </div>
        </section>

        <!-- COMPETITOR LANDSCAPE SECTION -->
        <section id="landscape" class="scroll-mt-24">
            <div class="mb-6">
                <h3 class="text-2xl font-bold text-stone-800">2. Competitor Landscape (Canteen & Peers)</h3>
                <p class="text-stone-600 mt-2">
                    Analyze the mix of National Operators, Regional Specialists, and Manufacturers competing for market share with Canteen Canada. 
                    Interact with the chart or buttons to filter the detailed competitor list.
                </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left: Controls & Chart -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl card-shadow border border-stone-100">
                        <h4 class="font-semibold text-stone-700 mb-4 text-sm uppercase tracking-wider">Market Distribution</h4>
                        
                        <!-- Chart Container -->
                        <div class="chart-container">
                            <canvas id="competitorChart"></canvas>
                        </div>
                        
                        <div class="mt-6 flex flex-wrap gap-2 justify-center">
                            <button onclick="filterCompetitors('All')" class="comp-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-stone-800 text-white hover:bg-stone-700 transition-colors" data-type="All">Show All</button>
                            <button onclick="filterCompetitors('National Operator')" class="comp-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-stone-100 text-stone-600 hover:bg-stone-200 transition-colors" data-type="National Operator">National</button>
                            <button onclick="filterCompetitors('Regional')" class="comp-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-stone-100 text-stone-600 hover:bg-stone-200 transition-colors" data-type="Regional">Regional</button>
                            <button onclick="filterCompetitors('Manufacturer')" class="comp-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-stone-100 text-stone-600 hover:bg-stone-200 transition-colors" data-type="Manufacturer">Manufacturer</button>
                        </div>
                    </div>
                </div>

                <!-- Right: Competitor Cards Grid -->
                <div class="lg:col-span-2">
                    <div id="competitorGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Cards injected via JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- SEARCH TERM ANALYSIS SECTION -->
        <section id="search" class="scroll-mt-24">
            <div class="mb-6">
                <h3 class="text-2xl font-bold text-stone-800">3. Canteen's Search Term Strategy (Reverse-Engineered)</h3>
                <p class="text-stone-600 mt-2">
                    Understanding the search terms Canteen is likely targeting is crucial for VMC’s counter-strategy. We have categorized high-priority keywords into five strategic buckets.
                    Select a category to view the specific terms and their estimated strategic priority.
                </p>
            </div>

            <div class="bg-white rounded-xl card-shadow border border-stone-100 overflow-hidden">
                <!-- Tabs -->
                <div class="flex overflow-x-auto border-b border-stone-100 bg-stone-50">
                    <button onclick="loadSearchCategory('brand')" class="search-tab active px-6 py-4 text-sm font-medium text-stone-600 whitespace-nowrap border-b-2 border-transparent hover:text-stone-800 focus:outline-none" data-cat="brand">Brand Intent</button>
                    <button onclick="loadSearchCategory('commercial')" class="search-tab px-6 py-4 text-sm font-medium text-stone-600 whitespace-nowrap border-b-2 border-transparent hover:text-stone-800 focus:outline-none" data-cat="commercial">Commercial</button>
                    <button onclick="loadSearchCategory('local')" class="search-tab px-6 py-4 text-sm font-medium text-stone-600 whitespace-nowrap border-b-2 border-transparent hover:text-stone-800 focus:outline-none" data-cat="local">Local SEO</button>
                    <button onclick="loadSearchCategory('tech')" class="search-tab px-6 py-4 text-sm font-medium text-stone-600 whitespace-nowrap border-b-2 border-transparent hover:text-stone-800 focus:outline-none" data-cat="tech">Innovation</button>
                    <button onclick="loadSearchCategory('related')" class="search-tab px-6 py-4 text-sm font-medium text-stone-600 whitespace-nowrap border-b-2 border-transparent hover:text-stone-800 focus:outline-none" data-cat="related">Related Services</button>
                </div>

                <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                    <!-- Text List -->
                    <div>
                        <h4 id="searchCatTitle" class="text-lg font-bold text-stone-800 mb-2">Brand + Service Intent</h4>
                        <p id="searchCatDesc" class="text-sm text-stone-500 mb-4">High-value searches specifically targeting Canteen's existing reputation.</p>
                        
                        <div class="bg-stone-50 rounded-lg p-4 max-h-[300px] overflow-y-auto border border-stone-200">
                            <ul id="searchTermList" class="space-y-3">
                                <!-- List items injected via JS -->
                            </ul>
                        </div>
                    </div>

                    <!-- Bar Chart -->
                    <div class="w-full">
                         <h5 class="text-xs font-bold text-stone-400 uppercase tracking-widest mb-4 text-center">Strategic Importance Score</h5>
                         <!-- Chart Container -->
                        <div class="chart-container">
                            <canvas id="searchChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PPC COUNTER-STRATEGY SECTION (Updated for VMC) -->
        <section id="ppc" class="scroll-mt-24">
            <div class="mb-6">
                <h3 class="text-2xl font-bold text-stone-800">4. VMC's Aggressive PPC Counter-Strategy</h3>
                <p class="text-stone-600 mt-2">
                    These are Vending Machine Canada's suggested Google Ads structures, designed to **attack the vulnerabilities** of Canteen Canada's nationwide approach.
                    Review the strategies below and **generate highly competitive ad copy** tailored for VMC.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Sidebar Controls -->
                <div class="md:col-span-1 space-y-3">
                    <button onclick="renderPPC('brand_attack')" class="ppc-btn w-full text-left px-4 py-3 rounded-lg text-sm font-medium bg-stone-800 text-white shadow-md transition-all-300 transform hover:scale-105" data-key="brand_attack">Competitor Brand Attack</button>
                    <button onclick="renderPPC('local_dominance')" class="ppc-btn w-full text-left px-4 py-3 rounded-lg text-sm font-medium bg-white text-stone-600 border border-stone-200 hover:bg-stone-50 transition-all-300" data-key="local_dominance">Local Service Dominance</button>
                    <button onclick="renderPPC('healthy_disruption')" class="ppc-btn w-full text-left px-4 py-3 rounded-lg text-sm font-medium bg-white text-stone-600 border border-stone-200 hover:bg-stone-50 transition-all-300" data-key="healthy_disruption">Healthy Niche Disruption</button>
                    <button onclick="renderPPC('quality_focus')" class="ppc-btn w-full text-left px-4 py-3 rounded-lg text-sm font-medium bg-white text-stone-600 border border-stone-200 hover:bg-stone-50 transition-all-300" data-key="quality_focus">Quality & Maintenance Focus</button>
                </div>

                <!-- Dynamic Content Area -->
                <div class="md:col-span-3">
                    <div id="ppcContent" class="bg-white rounded-xl card-shadow p-8 border border-stone-100 h-full flex flex-col justify-center transition-all-300">
                        <!-- Content injected via JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- INSIGHTS SECTION -->
        <section id="insights" class="scroll-mt-24 mb-12">
            <div class="bg-stone-800 rounded-2xl p-8 md:p-12 text-white">
                <div class="mb-8">
                    <h3 class="text-2xl font-bold">5. Strategic Insights & Recommendation for VMC</h3>
                    <p class="text-stone-300 mt-2">Executive summary based on Canteen's strategy for Vending Machine Canada's roadmap.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-stone-700/50 p-6 rounded-lg backdrop-blur-sm border border-stone-600">
                        <div class="text-amber-500 text-2xl mb-3">&#9737;</div> <!-- Target Icon -->
                        <h4 class="font-bold text-lg mb-2">Local + Benefit Counter-Strategy</h4>
                        <p class="text-stone-300 text-sm leading-relaxed">
                            Canteen likely targets "healthy vending Toronto." VMC should create hyper-localized pages with specific city names, underscoring local service superiority.
                        </p>
                    </div>
                    <div class="bg-stone-700/50 p-6 rounded-lg backdrop-blur-sm border border-stone-600">
                        <div class="text-amber-500 text-2xl mb-3">&#8862;</div> <!-- Plus/Square Icon -->
                        <h4 class="font-bold text-lg mb-2">The Healthy Niche Opportunity</h4>
                        <p class="text-stone-300 text-sm leading-relaxed">
                            Canteen is weak here. VMC should build an authoritative content hub and aggressively bid on "healthy" keywords, offering a specialized alternative to the national giants.
                        </p>
                    </div>
                    <div class="bg-stone-700/50 p-6 rounded-lg backdrop-blur-sm border border-stone-600">
                        <div class="text-amber-500 text-2xl mb-3">&#10022;</div> <!-- Star Icon -->
                        <h4 class="font-bold text-lg mb-2">Primary VMC USP</h4>
                        <p class="text-stone-300 text-sm leading-relaxed">
                            Focus VMC's messaging on being the local expert (vs. Canteen's national reach). Leverage direct owner involvement and personalized service as the competitive edge.
                        </p>
                    </div>
                </div>

                <!-- NEW GEMINI FEATURE: EXECUTIVE SUMMARY -->
                <div class="mt-10 pt-6 border-t border-stone-600">
                    <h3 class="text-2xl font-bold mb-4">6. Final Executive Briefing (LLM Generated)</h3>
                    <p class="text-stone-300 mb-6">
                        Generate a concise, high-impact one-paragraph briefing for Evan, synthesizing the competitive analysis and recommending the single most critical action VMC must take.
                    </p>
                    
                    <div class="text-center mb-6">
                        <button onclick="generateExecutiveSummary()" class="px-6 py-3 bg-white text-stone-800 font-bold rounded-full shadow-xl hover:bg-stone-200 transition-colors flex items-center justify-center mx-auto text-lg">
                            Generate Evan's Executive Summary ✨
                        </button>
                    </div>

                    <div id="executiveSummaryResult" class="min-h-[100px] flex items-center justify-center bg-stone-700/50 p-6 rounded-lg text-stone-200 italic text-sm">
                        <p>Click the button above to synthesize the final recommendation.</p>
                    </div>
                </div>
                
            </div>
        </section>

    </main>

    <!-- FOOTER (Updated for Attribution) -->
    <footer class="bg-stone-900 text-stone-400 py-8 border-t border-stone-800">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-sm">Prepared by Jose Espinosa for Vending Machine Canada (<a href="https://vendingcanada.ca/" class="text-amber-500 hover:text-amber-400">vendingcanada.ca</a>). &copy; 2025 Competitive Strategy Report.</p>
        </div>
    </footer>

    <!-- LOGIC SCRIPT -->
    <script>
        // --- DATA STORAGE & CONFIGURATION ---

        const apiKey = "AIzaSyCj4NKq2C_kXLfH27vfq_l_Iu8XMtlaXkc"; 
        const modelName = "gemini-2.5-flash-preview-09-2025";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

        const competitorData = [
            { name: "Canteen Canada", type: "National Operator", strength: "Full-service, Tech-enabled, National", notes: "Market Leader Baseline" },
            { name: "Aramark Refreshment", type: "National Operator", strength: "Corporate clients, Catering", notes: "Strong enterprise contracts" },
            { name: "BetterVending", type: "Niche/Healthy", strength: "Organic focus, Ontario-based", notes: "Healthy Niche Leader" },
            { name: "Healthy Max", type: "Niche/Healthy", strength: "Nutritional snacks, Combo machines", notes: "Toronto-centric" },
            { name: "Fresh Healthy Vending", type: "Niche/Healthy", strength: "Smart machines, Healthy options", notes: "Local focus" },
            { name: "Selecta Canada", type: "National Operator", strength: "Legacy brand, Regional presence", notes: "Snack & Beverage vending" },
            { name: "Fraser Valley Vending", type: "Regional", strength: "Snack/Drink/Frozen", notes: "Vancouver area" },
            { name: "Vend Pro", type: "Regional", strength: "Workplace vending", notes: "Ottawa B2B focus" },
            { name: "Kane’s Distributing", type: "Distributor", strength: "Refurbished & New machines", notes: "Nationwide" },
            { name: "QM Distribution", type: "Distributor", strength: "Smart machines, AI monitoring", notes: "Nationwide coverage" },
            { name: "Royal Vendors", type: "Manufacturer", strength: "Beverage vending machines", notes: "Via distributors" },
            { name: "AMS", type: "Manufacturer", strength: "Snack/drink combo machines", notes: "Widely distributed" },
            { name: "Seaga Manufacturing", type: "Manufacturer", strength: "Reliable machines", notes: "Nationwide distributor" }
        ];

        const searchData = {
            brand: {
                title: "Brand + Service Intent",
                desc: "Direct navigation queries indicating high brand familiarity.",
                color: 'rgba(217, 119, 6, 0.8)', // Amber-600
                items: [
                    { term: "Canteen Canada vending services", score: 95 },
                    { term: "Canteen micro-markets", score: 90 },
                    { term: "Canteen vending machines Canada", score: 85 },
                    { term: "Canteen break room solutions", score: 80 },
                    { term: "Canteen corporate vending", score: 75 }
                ]
            },
            commercial: {
                title: "Commercial / Purchase Intent",
                desc: "High-conversion queries from decision makers looking for suppliers.",
                color: 'rgba(41, 37, 36, 0.8)', // Stone-800
                items: [
                    { term: "vending machine services Canada", score: 92 },
                    { term: "office vending provider", score: 88 },
                    { term: "commercial vending solutions", score: 85 },
                    { term: "vending machine supplier Canada", score: 82 },
                    { term: "healthy vending machines Canada", score: 78 }
                ]
            },
            local: {
                title: "Location + Local SEO",
                desc: "Geo-specific queries. Critical for capturing regional market share.",
                color: 'rgba(87, 83, 78, 0.8)', // Stone-600
                items: [
                    { term: "vending machine services in Toronto", score: 88 },
                    { term: "Vancouver office vending solutions", score: 85 },
                    { term: "Montreal snack vending machines", score: 80 },
                    { term: "Ottawa vending machines near me", score: 75 },
                    { term: "Edmonton micro-markets", score: 70 }
                ]
            },
            tech: {
                title: "Feature / Technology",
                desc: "Innovation-focused queries targeting modern solutions.",
                color: 'rgba(120, 113, 108, 0.8)', // Stone-500
                items: [
                    { term: "smart vending machines Canada", score: 85 },
                    { term: "cashless vending machines", score: 82 },
                    { term: "remote inventory vending technology", score: 78 },
                    { term: "custom vending menus Canada", score: 70 }
                ]
            },
            related: {
                title: "Related Services",
                desc: "Cross-sell opportunities for broader breakroom needs.",
                color: 'rgba(168, 162, 158, 0.8)', // Stone-400
                items: [
                    { term: "office coffee service Canada", score: 90 },
                    { term: "corporate pantry service Canada", score: 85 },
                    { term: "healthy snack program vending", score: 80 }
                ]
            }
        };

        // PPC Strategies for VMC (Counter-Strategy)
        const ppcStrategies = {
            brand_attack: {
                title: "Competitor Brand Attack (Canteen)",
                group: "Canteen Branded Terms",
                keywords: ["“Canteen Canada”", "Canteen vending services", "Canteen micro-markets"],
                desc: "Goal: Steal high-intent traffic directly from Canteen searchers. **Strategy**: Highlight VMC's local, personalized service vs. Canteen's national, hands-off approach."
            },
            local_dominance: {
                title: "Local Service Dominance Campaign",
                group: "Geo-Targeted Services",
                keywords: ["vending machine services Toronto", "local office vending provider", "vending machines near me"],
                desc: "Goal: Dominate local search results. **Strategy**: Use geo-modifiers to assure users VMC offers faster service and local support that national chains cannot match."
            },
            healthy_disruption: {
                title: "Healthy Niche Disruption Campaign",
                group: "High-Quality Healthy Vending",
                keywords: ["best healthy vending Canada", "gourmet office snacks vending", "organic vending services"],
                desc: "Goal: Capture the high-value 'wellness' segment. **Strategy**: Position VMC as the premium, health-focused alternative, emphasizing fresh, curated selections."
            },
            quality_focus: {
                title: "Service Quality & Maintenance Focus",
                group: "Reliability & Service",
                keywords: ["reliable vending machine service", "vending machine repair response", "24/7 vending refill service"],
                desc: "Goal: Address pain points with national operators. **Strategy**: Directly tackle common complaints (slow refills, broken machines) by promoting VMC's quick response times and new equipment."
            }
        };

        // --- GLOBAL CHART VARIABLES & STATE ---
        let compChartInstance = null;
        let searchChartInstance = null;
        let currentPPCStrategy = 'brand_attack'; 

        // --- HELPER FUNCTIONS ---

        function showLoading(elementId) {
            const container = document.getElementById(elementId);
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8 text-stone-500">
                    <svg class="animate-spin h-6 w-6 text-amber-600 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-sm text-stone-400">Generating competitive ad copy with Gemini...</p>
                </div>
            `;
        }
        
        function showLoadingSummary(elementId) {
            const container = document.getElementById(elementId);
            container.classList.remove('text-stone-200', 'italic', 'text-sm'); // Remove default text styling
             container.innerHTML = `
                <div class="flex flex-col items-center justify-center p-4 text-stone-500">
                    <svg class="animate-spin h-6 w-6 text-amber-500 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-sm text-stone-300">Synthesizing final executive briefing...</p>
                </div>
            `;
        }

        async function fetchWithExponentialBackoff(fetcher, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fetcher();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // --- GEMINI INTEGRATION 1: AD COPY GENERATOR ---

        async function generateAdCopy() {
            // Check for API key presence
            if (!apiKey) {
                const adCopyContainer = document.getElementById('adCopyResult');
                adCopyContainer.innerHTML = `
                    <div class="text-red-600 text-sm p-4 bg-red-50 rounded-lg">
                        Error: API Key is missing. Please replace 'const apiKey = "";' with your actual Gemini API Key to run this locally.
                    </div>
                `;
                return; 
            }

            const strategyKey = currentPPCStrategy;
            const strategy = ppcStrategies[strategyKey];
            const adCopyContainer = document.getElementById('adCopyResult');

            showLoading('adCopyResult');

            // Hyper-competitive prompt for VMC, highlighting local service vs. national chains (like Canteen)
            const systemPrompt = "You are a hyper-aggressive, B2B digital marketing copywriter for Vending Machine Canada (VMC). Your tone must be highly competitive, directly comparing VMC's local expertise and superior service against national chains. You MUST format your response with a clear 'Headline 1:', 'Headline 2:', and 'Description 1:' label on separate lines. Keep the headlines concise (max 30 chars) and the description focused (max 90 chars).";
            const userQuery = `Generate compelling Google Ads copy for Vending Machine Canada based on the following VMC ad group strategy: "${strategy.desc}" The target keywords are: ${strategy.keywords.join(', ')}. Focus on: Local Ownership, Faster Service, and Better Snack Selection.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithExponentialBackoff(() => fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Could not generate content.";
                
                displayAdCopy(text);

            } catch (error) {
                console.error("Gemini API call failed:", error);
                adCopyContainer.innerHTML = `
                    <div class="text-red-600 text-sm p-4 bg-red-50 rounded-lg">
                        Error generating ad copy: API call failed or response was invalid. Check your API key and network connection.
                    </div>
                `;
            }
        }

        function displayAdCopy(text) {
            const adCopyContainer = document.getElementById('adCopyResult');
            // Parsing the response based on the strict prompt instructions
            const lines = text.split('\n').filter(line => line.trim() !== '');
            
            let headline1 = "N/A";
            let headline2 = "N/A";
            let description = "N/A";

            lines.forEach(line => {
                if (line.startsWith('Headline 1:')) {
                    headline1 = line.substring('Headline 1:'.length).trim();
                } else if (line.startsWith('Headline 2:')) {
                    headline2 = line.substring('Headline 2:'.length).trim();
                } else if (line.startsWith('Description 1:')) {
                    description = line.substring('Description 1:'.length).trim();
                }
            });

            adCopyContainer.innerHTML = `
                <div class="space-y-4">
                    <h5 class="text-sm font-semibold text-stone-700 mb-1 border-b border-stone-200 pb-2">Generated VMC Competitive Ad Copy:</h5>
                    
                    <!-- Ad Preview Card (Tailored for VMC) -->
                    <div class="p-4 rounded-lg ad-copy-preview shadow-lg">
                        <p class="text-xs ad-url mb-1 font-mono">vendingcanada.ca/local-service</p>
                        <p class="text-sm ad-headline leading-tight">${headline1} | ${headline2}</p>
                        <p class="text-sm text-stone-700 leading-snug">${description}</p>
                        <div class="mt-2 text-xs text-stone-500 flex justify-between">
                            <span>Ad Status: Active</span>
                        </div>
                    </div>

                    <div class="text-xs text-stone-500 italic mt-4">
                        Note: This copy is designed to out-perform national competitors. Verify character limits before deployment.
                    </div>
                </div>
            `;
        }

        // --- GEMINI INTEGRATION 2: EXECUTIVE SUMMARY GENERATOR ---

        async function generateExecutiveSummary() {
            if (!apiKey) {
                document.getElementById('executiveSummaryResult').innerHTML = `
                    <div class="text-red-300 text-sm p-2 bg-red-800/50 rounded-lg">
                        Error: API Key is missing.
                    </div>
                `;
                return;
            }

            const container = document.getElementById('executiveSummaryResult');
            showLoadingSummary('executiveSummaryResult'); 

            // Comprehensive prompt for the CEO summary
            const systemPrompt = "You are a Chief Strategy Officer writing a confident, single-paragraph executive summary for the company owner, Evan. The summary must be highly actionable, combining all three strategies (Brand Attack, Local Dominance, Healthy Niche Disruption) into one powerful final recommendation. The tone must be professional, brief, and decisive.";
            
            const userQuery = `Based on the competitor analysis of Canteen Canada and the recommended VMC counter-strategy (Brand Attack, Local Dominance, Healthy Niche Disruption), synthesize a final, high-level, single-paragraph executive briefing for the owner. The summary must conclude by identifying VMC's single greatest competitive advantage (Local Owner involvement, Freshness, or Fast Service) to focus on in PPC and service.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithExponentialBackoff(() => fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Could not generate content.";
                
                displayExecutiveSummary(text);

            } catch (error) {
                console.error("Gemini API call failed for summary:", error);
                container.innerHTML = `
                    <div class="text-red-300 text-sm p-2 bg-red-800/50 rounded-lg">
                        Error generating summary: API call failed.
                    </div>
                `;
            }
        }

        function displayExecutiveSummary(summaryText) {
            const container = document.getElementById('executiveSummaryResult');
            container.classList.remove('italic', 'text-sm', 'text-stone-400');
            container.innerHTML = `<p class="text-lg font-medium text-stone-50 leading-relaxed">${summaryText}</p>`;
        }


        // --- CORE FUNCTIONS (Unchanged from previous versions) ---

        function initCompetitorChart() {
            const ctx = document.getElementById('competitorChart').getContext('2d');
            
            // Aggregating Data
            const typeCounts = {};
            competitorData.forEach(c => {
                let type = c.type;
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });

            const labels = Object.keys(typeCounts);
            const data = Object.values(typeCounts);

            compChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#292524', // Stone-800
                            '#d97706', // Amber-600
                            '#a8a29e', // Stone-400
                            '#57534e', // Stone-600
                            '#e7e5e4'  // Stone-200
                        ],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                font: { family: 'Inter', size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` ${context.label}: ${context.raw} Companies`;
                                }
                            }
                        },
                         datalabels: { // Removed datalabels as it requires an external library and violates the single file mandate
                            display: false
                        }
                    },
                    layout: {
                        padding: 10
                    }
                }
            });
        }

        function filterCompetitors(type) {
            // Update Buttons
            document.querySelectorAll('.comp-filter-btn').forEach(btn => {
                if (btn.dataset.type === type) {
                    btn.classList.remove('bg-stone-100', 'text-stone-600');
                    btn.classList.add('bg-stone-800', 'text-white');
                } else {
                    btn.classList.add('bg-stone-100', 'text-stone-600');
                    btn.classList.remove('bg-stone-800', 'text-white');
                }
            });

            // Filter Data
            const grid = document.getElementById('competitorGrid');
            grid.innerHTML = '';

            const filtered = type === 'All' 
                ? competitorData 
                : competitorData.filter(c => {
                    if (type === 'Regional') return c.type === 'Regional' || c.type === 'Niche/Healthy';
                    return c.type === type;
                });

            // Render Cards
            filtered.forEach(c => {
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-lg border border-stone-200 hover:border-amber-500 transition-colors shadow-sm";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h5 class="font-bold text-stone-800">${c.name}</h5>
                        <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 bg-stone-100 text-stone-500 rounded">${c.type}</span>
                    </div>
                    <p class="text-xs text-amber-600 font-semibold mb-1">Strength: ${c.strength}</p>
                    <p class="text-xs text-stone-500 italic">"${c.notes}"</p>
                `;
                grid.appendChild(card);
            });
        }

        function initSearchChart() {
            const ctx = document.getElementById('searchChart').getContext('2d');
            searchChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Strategic Priority',
                        data: [],
                        backgroundColor: '#d97706',
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            grid: { display: false }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { font: { family: 'Inter', size: 10 } }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => ` Priority Score: ${ctx.raw}/100`
                            }
                        }
                    }
                }
            });
        }

        function loadSearchCategory(catKey) {
            // Update Tabs
            document.querySelectorAll('.search-tab').forEach(t => {
                if(t.dataset.cat === catKey) {
                    t.classList.add('border-amber-600', 'text-stone-800');
                    t.classList.remove('border-transparent', 'text-stone-600');
                } else {
                    t.classList.remove('border-amber-600', 'text-stone-800');
                    t.classList.add('border-transparent', 'text-stone-600');
                }
            });

            const data = searchData[catKey];
            
            // Update Text Info
            document.getElementById('searchCatTitle').innerText = data.title;
            document.getElementById('searchCatDesc').innerText = data.desc;

            // Update List
            const list = document.getElementById('searchTermList');
            list.innerHTML = '';
            data.items.forEach(item => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center text-sm p-2 hover:bg-white rounded transition-colors";
                li.innerHTML = `
                    <span class="text-stone-700 font-medium">“${item.term}”</span>
                `;
                list.appendChild(li);
            });

            // Update Chart
            if (searchChartInstance) {
                searchChartInstance.data.labels = data.items.map(i => i.term.length > 20 ? i.term.substring(0,20)+'...' : i.term);
                searchChartInstance.data.datasets[0].data = data.items.map(i => i.score);
                searchChartInstance.data.datasets[0].backgroundColor = data.color;
                searchChartInstance.update();
            }
        }

        function renderPPC(strategyKey) {
            currentPPCStrategy = strategyKey; // Update state tracking
            // Update Buttons style
            const buttons = document.querySelectorAll('.ppc-btn');
            
            buttons.forEach(btn => {
                if (btn.dataset.key === strategyKey) {
                    btn.classList.remove('bg-white', 'text-stone-600', 'border-stone-200');
                    btn.classList.add('bg-stone-800', 'text-white', 'border-transparent', 'shadow-md', 'transform', 'scale-105');
                } else {
                    btn.classList.add('bg-white', 'text-stone-600', 'border-stone-200');
                    btn.classList.remove('bg-stone-800', 'text-white', 'border-transparent', 'shadow-md', 'transform', 'scale-105');
                }
            });

            const s = ppcStrategies[strategyKey];
            const container = document.getElementById('ppcContent');
            
            // Fade out effect
            container.style.opacity = '0';
            
            setTimeout(() => {
                container.innerHTML = `
                    <div class="mb-4">
                        <span class="text-xs font-bold text-amber-600 uppercase tracking-widest">VMC's Ad Group Strategy</span>
                        <h4 class="text-2xl font-bold text-stone-800 mt-1">${s.group}</h4>
                        <p class="text-stone-500 mt-2 text-sm italic">${s.desc}</p>
                    </div>
                    
                    <div class="bg-stone-50 border border-stone-200 rounded-lg p-6">
                        <h5 class="text-sm font-semibold text-stone-700 mb-3 border-b border-stone-200 pb-2">Target Keywords for VMC</h5>
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${s.keywords.map(k => `<span class="px-3 py-1 bg-white border border-stone-300 text-stone-600 rounded-full text-sm shadow-sm font-mono">${k}</span>`).join('')}
                        </div>
                        
                        <!-- GEMINI FEATURE BUTTON -->
                        <div class="text-center mt-6">
                            <button onclick="generateAdCopy()" class="px-5 py-2 bg-amber-600 text-white font-semibold rounded-full shadow-lg hover:bg-amber-700 transition-colors flex items-center justify-center mx-auto">
                                Generate VMC Counter-Ad Copy ✨
                            </button>
                        </div>

                    </div>
                    
                    <!-- Ad Copy Generation Result Area -->
                    <div id="adCopyResult" class="mt-6 p-4 border border-stone-200 rounded-lg min-h-[120px] flex items-center justify-center">
                        <p class="text-sm text-stone-400">Click 'Generate VMC Counter-Ad Copy ✨' to create suggested, aggressive ad text.</p>
                    </div>

                `;
                container.style.opacity = '1';
            }, 300);
        }

        function scrollToSection(id) {
            document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
        }

        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', () => {
            initCompetitorChart();
            filterCompetitors('All'); 
            
            initSearchChart();
            loadSearchCategory('brand'); 

            renderPPC('brand_attack'); 
        });

    </script>
</body>
</html>
