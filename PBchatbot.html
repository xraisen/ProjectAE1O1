<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planet Beauty AI Chatbot</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #fefefe;
            min-height: 100vh;
        }
        .chat-container {
            height: 70vh;
            overflow-y: auto;
            scroll-behavior: smooth;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .chat-message {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .product-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .message-user {
            background-color: #e9f5ff;
            border-radius: 18px 18px 0 18px;
        }
        .message-bot {
            background-color: #f9f9f9;
            border-radius: 18px 18px 18px 0;
        }
        .typing-indicator {
            display: inline-flex;
            align-items: center;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            margin: 0 1px;
            background-color: #e91e63;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1s infinite alternate;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            from { transform: translateY(0px); }
            to { transform: translateY(-5px); }
        }
        .planet-beauty-pink {
            color: #e91e63;
        }
        .planet-beauty-bg {
            background-color: #e91e63;
        }
        .custom-shadow {
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.2);
        }
        @media print {
            body {
                width: 100%;
                margin: 0;
                padding: 0;
                background-color: white;
            }
            .chat-container {
                height: auto;
                overflow: visible;
                box-shadow: none;
            }
            .no-print {
                display: none;
            }
            .page-break {
                page-break-before: avoid;
            }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-between min-h-screen p-4 md:p-6">
    <header class="w-full max-w-4xl mb-4 text-center">
        <h1 class="text-3xl font-bold planet-beauty-pink">Planet Beauty</h1>
        <h2 class="text-lg text-gray-600">AI Beauty Assistant</h2>
    </header>

    <main class="w-full max-w-4xl flex-grow">
        <div class="rounded-lg overflow-hidden custom-shadow mb-6">
            <div id="chat-container" class="chat-container p-4 md:p-6"></div>
            <div class="p-4 bg-white border-t border-gray-200">
                <div id="api-key-section" class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <div class="flex flex-col md:flex-row md:items-center gap-2">
                        <input type="password" id="api-key-input" class="flex-grow p-2 border rounded" value="AIzaSyCVSFGoiMVSZ1YR3gx7bNX5YZQniYEnMZ4" placeholder="Enter Gemini API Key">
                        <input type="text" id="proxy-url-input" class="flex-grow p-2 border rounded" value="https://script.google.com/macros/s/AKfycbyzRwZr3QHp5aqekdK-PIwvarchIPue28sIDt0t0cez2InYYytoe7DI4lxfTlTg8LXl/exec" placeholder="Enter Google Apps Script URL">
                        <button id="validate-button" class="p-2 planet-beauty-bg text-white rounded hover:bg-opacity-90">Validate</button>
                    </div>
                    <div id="api-validation-status" class="mt-2 text-sm"></div>
                </div>
                <div class="flex items-center">
                    <input type="text" id="user-input" class="flex-grow p-3 border rounded-l focus:outline-none focus:ring-2 focus:ring-pink-300" placeholder="Ask about skincare, haircare, or makeup...">
                    <button id="send-button" class="p-3 planet-beauty-bg text-white rounded-r hover:bg-opacity-90 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <footer class="w-full max-w-4xl mt-8 text-center text-sm text-gray-500">
        <p>Developed by Jose Espinosa from AE1O1 | Owned by Ahmed Elhadi Â© 2024</p>
    </footer>

    <script>
        const apiKeyInput = document.getElementById('api-key-input');
        const proxyUrlInput = document.getElementById('proxy-url-input');
        const validateButton = document.getElementById('validate-button');
        const apiValidationStatus = document.getElementById('api-validation-status');
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        
        let apiKeyValidated = false;
        let conversationHistory = [];
        let userProfile = { skinType: null, skinTone: null, concerns: [] };

        const products = [
            { id: 'p1', name: 'Dermalogica Daily Microfoliant', description: 'Rice-based enzyme powder that microfoliates dulling debris for a smoother, brighter complexion.', price: '$59.00', image: 'https://www.planetbeauty.com/cdn/shop/files/884926_fd33021e-3e94-437e-ae29-3feff71c5d89_large.jpg?v=1686764326', url: 'https://www.planetbeauty.com/products/dermalogica-daily-microfoliant-2-6-oz', categories: ['exfoliant', 'brightening', 'skincare'], skinTypes: ['all', 'normal', 'combination', 'oily'], concerns: ['dullness', 'uneven texture', 'dark spots'] },
            { id: 'p2', name: 'Olaplex No. 4 Bond Maintenance Shampoo', description: 'Repairs and maintains bonds within the hair while gently cleansing.', price: '$30.00', image: 'https://www.planetbeauty.com/cdn/shop/products/olaplex-no-4-bond-maintenance-shampoo-8-5-oz_large.jpg?v=1673474648', url: 'https://www.planetbeauty.com/products/olaplex-no-4-bond-maintenance-shampoo-8-5-oz', categories: ['shampoo', 'haircare', 'damaged hair'], hairTypes: ['all', 'damaged', 'colored', 'fine'], concerns: ['breakage', 'damage', 'dryness'] },
            { id: 'p3', name: 'Dermalogica UltraCalming Cleanser', description: 'Gentle, pH-balanced gel cleanser for sensitive skin that calms and soothes reactive skin.', price: '$39.00', image: 'https://www.planetbeauty.com/cdn/shop/products/Dermalogica-UltraCalming-Cleanser_large.jpg?v=1634060242', url: 'https://www.planetbeauty.com/products/dermalogica-ultracalming-cleanser-16-9-oz', categories: ['cleanser', 'sensitive', 'skincare'], skinTypes: ['sensitive', 'dry', 'normal', 'combination'], concerns: ['redness', 'sensitivity', 'irritation'] },
            { id: 'p4', name: 'R+Co Television Perfect Hair Shampoo', description: 'Smoothing, strengthening, and volumizing shampoo for all hair types.', price: '$32.00', image: 'https://www.planetbeauty.com/cdn/shop/products/television-perfect-hair-shampoo_large.jpg?v=1644599399', url: 'https://www.planetbeauty.com/products/r-co-television-perfect-hair-shampoo-8-oz', categories: ['shampoo', 'haircare', 'volumizing'], hairTypes: ['all', 'fine', 'flat'], concerns: ['volume', 'shine', 'strength'] },
            { id: 'p5', name: 'Urban Decay All Nighter Setting Spray', description: 'Weightless setting spray that keeps makeup looking fresh for up to 16 hours.', price: '$33.00', image: 'https://www.planetbeauty.com/cdn/shop/products/urban-decay-all-nighter-setting-spray-4-oz_large.jpg?v=1662059219', url: 'https://www.planetbeauty.com/products/urban-decay-all-nighter-setting-spray', categories: ['makeup', 'setting spray', 'face'], skinTypes: ['all', 'normal', 'combination', 'oily'], concerns: ['longevity', 'melting', 'transfer'] },
            { id: 'p6', name: 'Moroccan Oil Treatment', description: 'Versatile, argan oil-infused treatment that detangles, speeds up drying time, and boosts shine.', price: '$34.00', image: 'https://www.planetbeauty.com/cdn/shop/products/moroccanoil-treatment-3-4-oz_large.jpg?v=1630612461', url: 'https://www.planetbeauty.com/products/moroccanoil-treatment-3-4-oz', categories: ['oil', 'treatment', 'haircare'], hairTypes: ['all', 'dry', 'damaged', 'frizzy'], concerns: ['frizz', 'dryness', 'shine'] },
            { id: 'p7', name: 'Drunk Elephant C-Firma Fresh Day Serum', description: 'Potent vitamin C day serum that firms and brightens the complexion while improving signs of photoaging.', price: '$78.00', image: 'https://www.planetbeauty.com/cdn/shop/products/C-Firma_Fresh_PARTS_A_B_Product_RGB-FW_large.jpg?v=1680537638', url: 'https://www.planetbeauty.com/products/drunk-elephant-c-firma-fresh-day-serum', categories: ['serum', 'vitamin c', 'brightening', 'skincare'], skinTypes: ['all', 'normal', 'combination', 'dry'], concerns: ['dullness', 'dark spots', 'firmness', 'aging'] },
            { id: 'p8', name: 'NARS Radiant Creamy Concealer', description: 'Award-winning concealer that provides medium-to-full, buildable coverage with a natural, radiant finish.', price: '$31.00', image: 'https://www.planetbeauty.com/cdn/shop/products/nars-radiant-creamy-concealer-0-22-oz_large.jpg?v=1672346923', url: 'https://www.planetbeauty.com/products/nars-radiant-creamy-concealer-0-22-oz', categories: ['makeup', 'concealer', 'face'], skinTypes: ['all', 'normal', 'dry', 'combination'], concerns: ['dark circles', 'blemishes', 'redness'] },
            { id: 'p9', name: 'Supergoop! Unseen Sunscreen SPF 40', description: 'Totally invisible, weightless, scentless formula with SPF 40 that leaves a velvety finish.', price: '$36.00', image: 'https://www.planetbeauty.com/cdn/shop/products/supergoop-unseen-sunscreen-spf-40-1-7-oz_large.jpg?v=1631897201', url: 'https://www.planetbeauty.com/products/supergoop-unseen-sunscreen-spf-40-1-7-oz', categories: ['sunscreen', 'skincare', 'protection'], skinTypes: ['all', 'oily', 'combination', 'normal'], concerns: ['sun protection', 'invisible finish', 'primer'] },
            { id: 'p10', name: 'Oribe Dry Texturizing Spray', description: 'Patented polymers absorb oil at the roots, leaving hair with incredible volume and sexy texture.', price: '$49.00', image: 'https://www.planetbeauty.com/cdn/shop/products/dry-texturizing-spray_large.jpg?v=1630543204', url: 'https://www.planetbeauty.com/products/oribe-dry-texturizing-spray-8-5-oz', categories: ['styling', 'texture', 'haircare'], hairTypes: ['all', 'fine', 'flat', 'oily'], concerns: ['volume', 'texture', 'oily roots'] },
            { id: 'p11', name: 'Dr. Dennis Gross Alpha Beta Extra Strength Daily Peel', description: 'Two-step anti-aging AHA/BHA peel pads that deliver clinical results without recovery time.', price: '$92.00', image: 'https://www.planetbeauty.com/cdn/shop/products/dr-dennis-gross-alpha-beta-extra-strength-daily-peel-30-treatments_large.jpg?v=1631635175', url: 'https://www.planetbeauty.com/products/dr-dennis-gross-alpha-beta-extra-strength-daily-peel-30-treatments', categories: ['treatment', 'exfoliant', 'skincare'], skinTypes: ['normal', 'combination', 'oily'], concerns: ['aging', 'uneven texture', 'large pores', 'dullness'] },
            { id: 'p12', name: 'Kiehl\'s Midnight Recovery Concentrate', description: 'Replenishing elixir of pure essential oils and distilled botanicals to visibly restore the appearance of skin by morning.', price: '$52.00', image: 'https://www.planetbeauty.com/cdn/shop/products/kiehls-midnight-recovery-concentrate-1-oz_large.jpg?v=1633736115', url: 'https://www.planetbeauty.com/products/kiehls-midnight-recovery-concentrate-1-oz', categories: ['night treatment', 'oil', 'skincare'], skinTypes: ['all', 'normal', 'dry', 'combination'], concerns: ['dryness', 'dullness', 'fine lines'] }
        ];

        document.addEventListener('DOMContentLoaded', function() {
            sendButton.disabled = true;
            userInput.disabled = true;
            
            addBotMessage(`
                <div class="mb-4">
                    <p class="font-medium">Welcome to your Planet Beauty Virtual Assistant! â¨</p>
                    <p class="mt-2">I'm here to help you find the perfect beauty products.</p>
                    <p class="mt-2">To get started, tell me:</p>
                    <ul class="list-disc pl-5 mt-2">
                        <li>Your skin type (dry, oily, combination, normal, sensitive)</li>
                        <li>Any specific beauty concerns or goals</li>
                        <li>What you're looking for today</li>
                    </ul>
                    <p class="mt-2">Please validate your API connection first!</p>
                </div>
            `);

            validateButton.addEventListener('click', validateAPIKey);
            sendButton.addEventListener('click', handleUserMessage);
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleUserMessage();
            });
        });

        async function validateAPIKey() {
            const apiKey = apiKeyInput.value.trim();
            const proxyUrl = proxyUrlInput.value.trim();
            
            if (!apiKey || !proxyUrl) {
                apiValidationStatus.innerHTML = '<span class="text-red-500">Enter both API key and proxy URL.</span>';
                return;
            }

            apiValidationStatus.innerHTML = '<span class="text-blue-500">Validating...</span>';
            
            try {
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiKey: apiKey,
                        prompt: "Test connection"
                    })
                });
                
                const data = await response.json();
                
                if (data && !data.error && (data.text || (data.candidates && data.candidates[0].content))) {
                    apiKeyValidated = true;
                    apiValidationStatus.innerHTML = '<span class="text-green-500">â Connected! Start chatting.</span>';
                    userInput.disabled = false;
                    sendButton.disabled = false;
                    userInput.focus();
                    setTimeout(() => { document.getElementById('api-key-section').style.display = 'none'; }, 1500);
                } else {
                    throw new Error("Invalid API response");
                }
            } catch (error) {
                apiValidationStatus.innerHTML = `<span class="text-red-500">â Failed: ${error.message}. Check API key/proxy.</span>`;
            }
        }

        async function handleUserMessage() {
            const message = userInput.value.trim();
            if (!message || !apiKeyValidated) return;
            
            addUserMessage(message);
            userInput.value = '';
            conversationHistory.push({ role: 'user', content: message });
            addTypingIndicator();
            userInput.disabled = true;
            sendButton.disabled = true;
            
            try {
                analyzeUserMessage(message);
                const prompt = generateAIPrompt(message);
                const response = await callGeminiAPI(prompt);
                await processAIResponse(response);
            } catch (error) {
                removeTypingIndicator();
                addBotMessage(`<p>Sorry, error occurred: ${error.message}. Try again.</p>`);
            }
            
            userInput.disabled = false;
            sendButton.disabled = false;
            userInput.focus();
        }

        function analyzeUserMessage(message) {
            const skinTypes = ['dry', 'oily', 'combination', 'normal', 'sensitive'];
            for (const type of skinTypes) {
                if (message.toLowerCase().includes(type)) {
                    userProfile.skinType = type;
                    break;
                }
            }
            const skinToneRegex = /(?:skin tone|complexion).*?(fair|light|medium|tan|dark|deep)/i;
            const toneMatch = message.match(skinToneRegex);
            if (toneMatch) userProfile.skinTone = toneMatch[1].toLowerCase();
            
            const concerns = ['acne', 'wrinkles', 'aging', 'dark spots', 'dark circles', 'redness', 'dryness', 'oiliness', 'dullness', 'pores', 'texture', 'frizz', 'volume', 'damage'];
            for (const concern of concerns) {
                if (message.toLowerCase().includes(concern) && !userProfile.concerns.includes(concern)) {
                    userProfile.concerns.push(concern);
                }
            }
        }

        function generateAIPrompt(message) {
            let prompt = `You are a beauty advisor for Planet Beauty. Provide personalized advice and recommend products from our catalog.\n\nUser info:`;
            if (userProfile.skinType) prompt += `\nSkin type: ${userProfile.skinType}`;
            if (userProfile.skinTone) prompt += `\nSkin tone: ${userProfile.skinTone}`;
            if (userProfile.concerns.length) prompt += `\nConcerns: ${userProfile.concerns.join(', ')}`;
            
            prompt += `\n\nHistory:`;
            conversationHistory.slice(-6).forEach(msg => {
                prompt += `\n${msg.role === 'user' ? 'Customer' : 'Advisor'}: ${msg.content}`;
            });
            
            prompt += `\n\nCurrent message: ${message}\n\nGuidelines:
                1. Be friendly and helpful
                2. Ask follow-ups if needed
                3. Use [PRODUCT_REC]Product Name[/PRODUCT_REC] for recommendations
                4. Explain why products suit the user
                5. Suggest 2-3 products max`;
            return prompt;
        }

        async function callGeminiAPI(prompt) {
            const apiKey = apiKeyInput.value.trim();
            const proxyUrl = proxyUrlInput.value.trim();
            
            const response = await fetch(proxyUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ apiKey: apiKey, prompt: prompt })
            });
            
            if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
            const data = await response.json();
            
            if (data.text) return data.text;
            if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) return data.candidates[0].content.parts[0].text;
            throw new Error("Unexpected API response");
        }

        async function processAIResponse(response) {
            removeTypingIndicator();
            conversationHistory.push({ role: 'assistant', content: response });
            
            const regex = /\[PRODUCT_REC\](.*?)\[\/PRODUCT_REC\]/gs;
            const recommendedProducts = [];
            let cleanedResponse = response;
            
            let match;
            while ((match = regex.exec(response)) !== null) {
                const productName = match[1].trim();
                const product = products.find(p => p.name.toLowerCase().includes(productName.toLowerCase()));
                if (product && !recommendedProducts.some(p => p.id === product.id)) recommendedProducts.push(product);
                cleanedResponse = cleanedResponse.replace(match[0], '');
            }
            
            addBotMessage(cleanedResponse.replace(/\n\n/g, '</p><p class="mt-2">').replace(/\n/g, '<br>'));
            if (recommendedProducts.length) displayProductRecommendations(recommendedProducts);
        }

        function addUserMessage(message) {
            const div = document.createElement('div');
            div.className = 'chat-message flex justify-end my-4';
            div.innerHTML = `<div class="max-w-3/4 message-user px-4 py-3"><p>${message}</p></div>`;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addBotMessage(message) {
            const div = document.createElement('div');
            div.className = 'chat-message flex my-4';
            div.innerHTML = `<div class="max-w-3/4 message-bot px-4 py-3">${message}</div>`;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function displayProductRecommendations(products) {
            const div = document.createElement('div');
            div.className = 'my-4';
            div.innerHTML = `
                <div class="mb-2 font-medium planet-beauty-pink">Recommended Products:</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${products.map(p => `
                        <div class="product-card rounded-lg border bg-white">
                            <div class="flex">
                                <div class="w-1/3 p-2">
                                    <img src="${p.image}" alt="${p.name}" class="w-full h-auto rounded">
                                </div>
                                <div class="w-2/3 p-3">
                                    <h3 class="font-medium text-sm planet-beauty-pink">${p.name}</h3>
                                    <p class="text-gray-700 text-xs mt-1">${p.description.substring(0, 60)}...</p>
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="font-bold text-sm">${p.price}</span>
                                        <a href="${p.url}" target="_blank" class="text-xs px-3 py-1 planet-beauty-bg text-white rounded">Shop Now</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addTypingIndicator() {
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'chat-message flex my-4';
            div.innerHTML = `<div class="message-bot px-4 py-3"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    </script>
</body>
  </html>
